# -*- mode: shell-script; -*-

unalias ls 2> /dev/null
alias ls='ls -F'

alias again='LEFTP=""; RIGHTP=""; source ~/.bashrc'

# to make this perm: set this option in dconf-editor; set the key:
# org/gnome/desktop/input-sources:xkb-options to  ['ctrl:nocaps']
# Thanks, KDP;

alias caps='setxkbmap -option ctrl:nocaps'
alias d='export d=`pwd` && echo "setting environment variable d to $d"'
alias dirs='echo $(builtin dirs) [$OLDPWD]'
alias goto='cd `/bin/pwd`'
alias rehash='export PATH=$PATH'
alias uncd='cd $OLDPWD'
alias scp='scp -c blowfish-cbc'
alias xf='(xfwm4 --replace &)'

ignoreeof=5

if [ "$LOGNAME" = root ]; then
    LEFTP="{"${LEFTP}
    RIGHTP=${RIGHTP}"}"
    key='#'
else
    LEFTP="["${LEFTP}
    RIGHTP=${RIGHTP}"]"
    key='%'
fi

PS1="${LEFTP}${LOGNAME}@${HOSTNAME}${RIGHTP} \#${key} "

function dt() {
    if [ -f /tmp/dir.txt ]; then
        export d=`cat /tmp/dir.txt`
        rm -f /tmp/dir.txt
	echo "Set environment variable d to $d ."
    else
	curdir=`/bin/pwd`
        echo $curdir > /tmp/dir.txt
	echo "Stored $curdir in /tmp/dir.txt ."
    fi
}

function manl () {
    nroff -man $1 | less
}

function adddot () {
    export PATH=".:$PATH"
}

function ediff () {
    emacs --eval "(ediff \"$1\" \"$2\")"
}

function rot13() {
    tr n-za-mN-ZA-M a-zA-Z
}

function enc() {
    if [ ! -d $HOME/enc ]; then
        mkdir $HOME/enc
    fi
    sudo mount -t ecryptfs $HOME/synced/enc $HOME/enc
    chmod 700 $HOME/enc
}

function unenc() {
    sudo umount $HOME/enc
    rmdir $HOME/enc
}

function find_media_dir() {
    # Sets MEDIA_DIR to the located media directory;
    MEDIABASE="/media/SanDisk32 /media/`whoami`/SanDisk32"
    searchdir=$1
    MEDIA_DIR=""
    for base in $MEDIABASE; do
        if [ -d $base/$searchdir ]; then
            MEDIA_DIR=$base/$searchdir
            break
        fi
    done
}

function encdocs() {
    if [ ! -d $HOME/encdocs ]; then
        mkdir $HOME/encdocs
    fi
    DOCS_DIR="$HOME/Dropbox/Documents/EncDocs"
    sudo mount -t ecryptfs $DOCS_DIR $HOME/encdocs
    chmod 700 $HOME/encdocs
}

function unencdocs() {
    sudo umount $HOME/encdocs
    rmdir $HOME/encdocs
}

function gnucashfs() {
    if [ ! -d $HOME/gnucash ]; then
        mkdir $HOME/gnucash;
    fi;
    find_media_dir gnucash
    if [ "$MEDIA_DIR" == "" ]; then
        echo "Could not locate gnucash directory." 1>&2
    else
        sudo mount -t ecryptfs $MEDIA_DIR $HOME/gnucash
    fi
}

ungnucashfs() {
    sudo umount $HOME/gnucash;
    rmdir $HOME/gnucash
}

function finance() {
    if mount | grep -q $HOME/finance; then
        echo "Finance directory already mounted" 1>&2
        return 1
    fi
    if [ ! -d $HOME/finance ]; then
        mkdir $HOME/finance
    fi
    echo "Mounting finance dir read-only"
    sudo mount -t ecryptfs -r /space/linked-dirs/Dropbox/Finance $HOME/finance
}

function finance-rw() {
    if [ ! -d $HOME/finance ]; then
        mkdir $HOME/finance
    fi
    sudo mount -t ecryptfs /space/linked-dirs/Dropbox/Finance $HOME/finance
}

function unfinance() {
    sudo umount $HOME/finance
    rmdir $HOME/finance
}

function sl() {
    if [ "$TERM" == "dumb" ]; then
        echo "skipping animation..."
    else
        /usr/games/sl "$*"
    fi
}

function stmarks() {
    if [ ! -f $HOME/enc/passwords/stmarks-ftp.txt ]; then
        echo "Encrypted filesystem not mounted."
        return 1
    fi
    if [ ! -d /mnt/stmarks ]; then
        sudo mkdir /mnt/stmarks
	sudo chown `whoami`:`whoami` /mnt/stmarks
    fi
    pass=`cat $HOME/enc/passwords/stmarks-ftp.txt`
    curlftpfs -o user=saintma7:$pass saint-marks.com /mnt/stmarks
}

function unstmarks() {
    sudo umount /mnt/stmarks
    sudo rmdir /mnt/stmarks
}

function rusa() {
    if [ ! -d /mnt/rusa ]; then
        sudo mkdir /mnt/rusa
	sudo chown `whoami`:`whoami` /mnt/rusa
    fi
    sshfs -p 1022 rusa@rusa.org:/ /mnt/rusa
}

function unrusa() {
    sudo umount /mnt/rusa
    sudo rmdir /mnt/rusa
}

function android() {
    if [ ! -d /mnt/android ]; then
        sudo mkdir /mnt/android
	sudo chown `whoami`:`whoami` /mnt/android
    fi
    sshfs root@192.168.1.78:/ /mnt/android
}

function unandroid() {
    sudo umount /mnt/android
    sudo rmdir /mnt/android
}

function android-backup() {
    if [ ! -d /mnt/android ]; then
        echo "nexus-s not mounted." 1>&2
	return 1
    fi
    cd /mnt/android/mnt/sdcard && \
      rsync -av  $*\
      --delete --delete-excluded \
      --exclude=*/com.google.android.music/cache/* \
      --exclude=*/com.google.earth/temp/* \
      --exclude=*/com.justpictures/cache/* \
      --exclude=\*.mp3 \
      --exclude=\*.m4v \
      --exclude=\*.mp4 \
      --exclude=Evernote/* \
      --exclude=InstaFetch/* \
      --exclude=com.economist/* \
      . rsync://backup@nas:/backup/dpb/nexus-s
}

function ro() {
    sudo mount -o ro,remount $1
}

function rw() {
    sudo mount -o rw,remount $1
}

function docker_clean() {
    docker rm `docker ps -a | awk '{print $1}'`
    docker rmi `docker images|grep -v orca|awk '{print $3}'`
}

# function openvpn() {
#     enc
#     cat ~/enc/armory/armory-vpn.txt
#     unenc
#     cd $HOME && sudo openvpn --config client.ovpn
# }


# Make a file in /etc/sudoers.d/ with this to allow shutdown without password -
#(username) (hostname) = ...
# dpb x100 = NOPASSWD: /sbin/init
function timer() {
    (sleep $1 && sudo /sbin/init 0) &
}

host_dot_bashrc="$HOME/synced/dot-files/dot-bashrc-`hostname`"
if [ -f $host_dot_bashrc ]; then
    . $host_dot_bashrc
fi

host_user_dot_bashrc="$HOME/synced/dot-files/dot-bashrc-`whoami`-`hostname`"
if [ -f $host_user_dot_bashrc ]; then
    . $host_user_dot_bashrc
fi
